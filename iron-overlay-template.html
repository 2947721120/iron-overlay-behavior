<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="iron-overlay-manager.html">

<script>
  /**
   * `overlay-template` should be used to overcome rendering issues [like this one](http://jsbin.com/lemufe/4/edit?html,output)
   * caused by [the stacking context](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Positioning/Understanding_z_index/The_stacking_context).
   *
   * `overlay-template` stamps the overlay and notifies that the overlay should
   * be appended by firing the event [`iron-overlay-template-attach`](#overlay-template:event-iron-overlay-template-attach).
   *
   * [`iron-overlay-container`](#iron-overlay-container) will listen to this event and
   * append the overlay as its child. Ensure you declare at least one in your document.
   *
   * ### Styling
   * You can pass styles within the template:
   *
   *      <template is="overlay-template">
   *        <style>
   *          paper-dialog { background-color: orange; }
   *        </style>
   *        <paper-dialog>My dialog</paper-dialog>
   *      </template>
   *
   * @demo demo/template.html
   */
  Polymer({
    is: 'overlay-template',
    extends: 'template',
    behaviors: [Polymer.Templatizer],
    properties: {
      /**
       * The overlay instance.
       */
      overlay: {
        type: Node,
        readOnly: true,
        notify: true
      }
    },
    ready: function() {
      this.__instance = null;
      // Must stamp so overlay gets registered, and we can check if it is
      // an overlay or not!
      this.templatize(this);
      var inst = this.stamp();
      var overlay = this._getOverlay(inst);
      if (!overlay) {
        throw Error('does not contain an overlay.');
      }
      this._handleStyles(inst);
      this.__instance = inst;
      this._setOverlay(overlay);
    },
    attached: function() {
      if (!this.overlay) {
        return;
      }
      var node = this.__instance ? this.__instance.root : this.overlay;
      this.fire('iron-overlay-template-attach', node, {cancelable: true});
      this.__instance = null;
    },
    detached: function() {
      if (!this.overlay) {
        return;
      }
      var parentNode = Polymer.dom(this.overlay).parentNode;
      if (parentNode) {
        Polymer.dom(parentNode).removeChild(this.overlay);
      }
    },
    /**
     * Implements extension point from Templatizer.
     * Forward values to overlay instance.
     */
    _forwardParentProp: function(prop, value) {
      if (this.overlay) {
        this.overlay._templateInstance[prop] = value;
      }
    },

    _getOverlay: function(instance) {
      var children = instance.root.children;
      for (var i = 0; i < children.length; i++) {
        if (Polymer.IronOverlayManager.isOverlay(children[i])) {
          return children[i];
        }
      }
    },


    /* TEMP, Polymer removes styles when included into nested templates */
    _handleStyles: function(instance) {
      var scripts = instance.root.querySelectorAll('script[type="css"]');
      for (var i = 0; i < scripts.length; i++) {
        var script = scripts[i];
        var css = script.textContent;
        var style = document.createElement('style');
        if (script.getAttribute('is') === 'custom-style') {
          style.setAttribute('is', 'custom-style');
        }
        if (style.styleSheet){
          style.styleSheet.cssText = css;
        } else {
          style.appendChild(document.createTextNode(css));
        }
        instance.root.insertBefore(style, script);
        instance.root.removeChild(script);
      }
    }
  });

  /**
   * Fired when the overlay is ready to be attached.
   * @event iron-overlay-template-attach
   * @param {Event} event The overlay attach can be prevented
   * by calling `event.preventDefault()`
   * @param {Node} event.detail The overlay instance to be attached (the contents of the template).
   */
</script>
